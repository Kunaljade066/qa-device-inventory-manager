<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QA Device Inventory Manager</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><circle cx='256' cy='256' r='256' fill='%231976d2'/><rect x='162' y='110' width='188' height='292' rx='36' ry='36' fill='white'/><rect x='190' y='150' width='132' height='210' fill='%231976d2'/></svg>" />
<style>
  :root {
    --bg-primary: #f5f7fa;
    --bg-secondary: white;
    --bg-header: #0052cc;
    --text-primary: #333;
    --text-secondary: #666;
    --text-header: white;
    --border-color: #ddd;
    --border-focus: #0052cc;
    --table-header-bg: #e8f0fe;
    --table-hover: #f9fafb;
    --shadow-light: rgba(0,0,0,0.1);
    --shadow-medium: rgba(0,0,0,0.3);
  }

  [data-theme="dark"] {
    --bg-primary: #1a1a1a;
    --bg-secondary: #2d2d2d;
    --bg-header: #0052cc;
    --text-primary: #e0e0e0;
    --text-secondary: #b0b0b0;
    --text-header: white;
    --border-color: #404040;
    --border-focus: #4a90e2;
    --table-header-bg: #3a3a3a;
    --table-hover: #353535;
    --shadow-light: rgba(0,0,0,0.3);
    --shadow-medium: rgba(0,0,0,0.5);
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
    background-attachment: fixed;
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
    color: var(--text-primary);
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
    transition: color 0.3s ease;
    position: relative;
    overflow-x: hidden;
    padding-bottom: 60px;
  }
  
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><radialGradient id="grad1" cx="50%" cy="50%" r="50%"><stop offset="0%" style="stop-color:%23334155;stop-opacity:0.3" /><stop offset="100%" style="stop-color:%23000000;stop-opacity:0.1" /></radialGradient></defs><circle cx="100" cy="100" r="300" fill="url(%23grad1)" transform="rotate(45 500 500)"/><circle cx="900" cy="300" r="200" fill="url(%23grad1)" transform="rotate(-30 500 500)"/><circle cx="200" cy="800" r="250" fill="url(%23grad1)" transform="rotate(60 500 500)"/></svg>') no-repeat center center;
    background-size: cover;
    opacity: 0.6;
    z-index: -2;
    pointer-events: none;
  }
  
  body::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 100px,
      rgba(255,255,255,0.01) 100px,
      rgba(255,255,255,0.01) 102px
    );
    z-index: -1;
    pointer-events: none;
  }
  
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  
  [data-theme="dark"] body {
    background: linear-gradient(135deg, #000000 0%, #0f172a 25%, #1e293b 50%, #334155 75%, #475569 100%);
    background-attachment: fixed;
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
  }
  
  [data-theme="dark"] body::before {
    opacity: 0.8;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><radialGradient id="grad1" cx="50%" cy="50%" r="50%"><stop offset="0%" style="stop-color:%23475569;stop-opacity:0.4" /><stop offset="100%" style="stop-color:%23000000;stop-opacity:0.2" /></radialGradient></defs><circle cx="100" cy="100" r="300" fill="url(%23grad1)" transform="rotate(45 500 500)"/><circle cx="900" cy="300" r="200" fill="url(%23grad1)" transform="rotate(-30 500 500)"/><circle cx="200" cy="800" r="250" fill="url(%23grad1)" transform="rotate(60 500 500)"/></svg>') no-repeat center center;
    background-size: cover;
  }
  
  header {
    background: var(--bg-header);
    color: var(--text-header);
    width: 100%;
    padding: 1rem 1rem;
    font-size: 1.5rem;
    font-weight: 700;
    box-shadow: 0 3px 6px var(--shadow-light);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-sizing: border-box;
  }
  
  .header-left {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    flex: 1;
    min-width: 0; /* Prevents overflow */
  }
  
  .header-icon {
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    padding: 0.25rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    backdrop-filter: blur(5px);
  }
  
  .header-title {
    font-size: 1.4rem;
    font-weight: 700;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .theme-toggle {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 0.5rem;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    flex-shrink: 0;
  }
  .theme-toggle:hover {
    background: rgba(255,255,255,0.3);
    border-color: rgba(255,255,255,0.5);
  }
  main {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    width: 95%;
    max-width: 900px;
    margin: 2rem 0 4rem 0;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    padding: 1rem 1.5rem 2rem 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
  }
  
  [data-theme="dark"] main {
    background: rgba(45, 55, 72, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }
  
  /* Mobile responsiveness */
  @media (max-width: 768px) {
    body::before {
      background-size: 150% 150%;
    }
    
    header {
      padding: 0.8rem 0.8rem;
    }
    
    .header-left {
      gap: 0.6rem;
    }
    
    .header-title {
      font-size: 1.2rem;
    }
    
    .header-icon {
      width: 38px;
      height: 38px;
    }
    
    .theme-toggle {
      width: 38px;
      height: 38px;
    }
    
    main {
      width: 98%;
      margin: 1rem 0 2rem 0;
      padding: 1rem;
      border-radius: 10px;
      backdrop-filter: blur(8px);
    }
    
    table {
      font-size: 0.9rem;
    }
    
    th, td {
      padding: 0.5rem 0.4rem;
    }
    
    .action-btn {
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
      margin-right: 0.2rem;
      margin-bottom: 0.2rem;
    }
    
    /* Stack action buttons vertically on very small screens */
    td:last-child {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      align-items: flex-start;
    }
    
    .modal-content {
      width: 95%;
      margin: 0 auto;
      padding: 1rem;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    [data-theme="dark"] .modal-content {
      background: rgba(45, 55, 72, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    input[type="text"], #editName, #editAssigned {
      font-size: 16px; /* Prevents zoom on iOS */
    }
    footer {
      font-size: 0.8rem;
      padding: 0.6rem 0.8rem;
    }
  }
  
  @media (max-width: 480px) {
    body::before {
      background-size: 120% 120%;
    }
    
    header {
      padding: 0.7rem 0.7rem;
      font-size: 1rem;
    }
    
    .header-left {
      gap: 0.4rem;
    }
    
    .header-title {
      font-size: 1rem;
    }
    
    .header-icon {
      width: 34px;
      height: 34px;
    }
    
    .theme-toggle {
      width: 34px;
      height: 34px;
    }
    
    main {
      padding: 0.8rem;
      border-radius: 8px;
      backdrop-filter: blur(6px);
    }
    
    /* Hide ID column on very small screens */
    th:first-child,
    td:first-child {
      display: none;
    }
    
    /* Adjust table layout for mobile */
    table {
      font-size: 0.85rem;
    }
    
    th, td {
      padding: 0.4rem 0.3rem;
    }
    
    .action-btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    
    form {
      gap: 0.6rem;
    }
    
    label {
      font-size: 0.95rem;
    }
    
    button {
      padding: 0.7rem 1rem;
      font-size: 0.95rem;
    }
    
    footer {
      font-size: 0.75rem;
      padding: 0.5rem 0.6rem;
    }
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  label { 
    font-weight: 600; 
    margin-bottom: 0.25rem; 
    color: var(--text-primary); 
  }
  input[type="text"] {
    padding: 0.5rem 0.75rem;
    border: 1.8px solid var(--border-color);
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    width: calc(100% - 1.5rem);
    box-sizing: border-box;
    background: var(--bg-secondary);
    color: var(--text-primary);
  }
  input[type="text"]:focus { 
    border-color: var(--border-focus); 
    outline: none; 
  }
  button {
    background-color: #0052cc;
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.3s ease;
    margin-top: 0.5rem;
    width: calc(100% - 1.5rem);
    box-sizing: border-box;
  }
  button:hover { background-color: #003d99; }
  table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 1.5rem; 
    font-size: 1rem;
    overflow-x: auto;
    display: block;
    white-space: nowrap;
  }
  
  thead, tbody, tr {
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  
  thead {
    width: calc(100% - 1em);
  }
  th, td { 
    text-align: left; 
    padding: 0.6rem 0.7rem; 
    border-bottom: 1px solid var(--border-color); 
  }
  th { 
    background: var(--table-header-bg); 
    font-weight: 600; 
  }
  tr:hover { 
    background-color: var(--table-hover); 
  }
  .status-in { color: #2d7a2d; font-weight: 700; }
  .status-out { color: #c43e3e; font-weight: 700; }
  .action-btn {
    background: #008cba;
    color: white;
    border: none;
    padding: 0.4rem 0.8rem;
    margin-right: 0.4rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    white-space: nowrap;
  }
  .action-btn.delete { background: #d9534f; }
  .action-btn.check { background: #5cb85c; }
  .action-btn.history { background: #6f42c1; }
  
  /* Action buttons container */
  .action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
  }

  /* Timestamp styling */
  .timestamp {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 0.2rem;
    white-space: normal;
    line-height: 1.4;
  }

  /* Modal styles */
  .modal {
    display: none; 
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background: var(--bg-secondary);
    color: var(--text-primary);
    padding: 1.5rem;
    border-radius: 8px;
    width: 90%; max-width: 500px;
    box-shadow: 0 3px 10px var(--shadow-medium);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    transition: background-color 0.3s ease, color 0.3s ease;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal-header { 
    font-size: 1.2rem; 
    font-weight: 700; 
    margin-bottom: 0.5rem;
  }
  .modal-actions { 
    display: flex; 
    justify-content: flex-end; 
    gap: 0.5rem; 
    margin-top: 1rem; 
  }
  .modal-actions button { 
    flex: 1; 
    padding: 0.6rem; 
    font-size: 1rem; 
    width: auto;
    margin-top: 0;
  }
  
  #editName, #editAssigned {
    padding: 0.5rem 0.75rem;
    border: 1.8px solid var(--border-color);
    border-radius: 6px;
    font-size: 1rem;
    background: var(--bg-secondary);
    color: var(--text-primary);
    transition: border-color 0.3s ease;
    width: calc(100% - 1.5rem);
    box-sizing: border-box;
  }
  #editName:focus, #editAssigned:focus {
    border-color: var(--border-focus);
    outline: none;
  }

  /* History modal styles */
  .history-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.5rem;
    background: var(--bg-primary);
  }
  .history-item {
    padding: 0.5rem;
    border-bottom: 1px solid var(--border-color);
  }
  .history-item:last-child {
    border-bottom: none;
  }

  [data-theme="dark"] .status-in { color: #4ade80; }
  [data-theme="dark"] .status-out { color: #f87171; }
</style>
</head>
<body>
<header>
  <div class="header-left">
    <div class="header-icon">
      <svg width="36" height="36" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <circle cx="256" cy="256" r="256" fill="#1976d2"/>
        <rect x="162" y="110" width="188" height="292" rx="36" ry="36" fill="white"/>
        <rect x="190" y="150" width="132" height="210" fill="#1976d2"/>
      </svg>
    </div>
    <span class="header-title">QA Device Inventory Manager</span>
  </div>
  <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
    <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="none">
      <!-- Sun icon for light mode (default) -->
      <circle cx="12" cy="12" r="5" fill="#FFD700"/>
      <line x1="12" y1="1" x2="12" y2="3" stroke="#FFD700" stroke-width="2"/>
      <line x1="12" y1="21" x2="12" y2="23" stroke="#FFD700" stroke-width="2"/>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="#FFD700" stroke-width="2"/>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="#FFD700" stroke-width="2"/>
      <line x1="1" y1="12" x2="3" y2="12" stroke="#FFD700" stroke-width="2"/>
      <line x1="21" y1="12" x2="23" y2="12" stroke="#FFD700" stroke-width="2"/>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="#FFD700" stroke-width="2"/>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="#FFD700" stroke-width="2"/>
    </svg>
  </button>
</header>
<main>
  <form id="deviceForm">
    <label for="deviceName">Device Name / Model *</label>
    <input type="text" id="deviceName" required placeholder="Enter device name or model" />
    <label for="deviceUser">Assigned To *</label>
    <input type="text" id="deviceUser" required placeholder="Enter assigned team member's name" />
    <button type="submit" id="formSubmitBtn">Add Device</button>
  </form>

  <div style="margin-top:1rem; display: flex; gap: 0.5rem; align-items: center; width: calc(100% - 1.5rem); box-sizing: border-box;">
    <button onclick="backupSheet()" style="flex: 1; margin-top: 0; width: auto;">Download Backup</button>
    <button onclick="document.getElementById('restoreFile').click()" style="background: #5cb85c; flex: 1; margin-top: 0; width: auto;">Restore Backup</button>
    <input type="file" id="restoreFile" onchange="restoreSheet(event)" style="display: none;" accept=".json" />
  </div>

  <table id="deviceTable" aria-label="Device inventory list" style="display: table; width: 100%; table-layout: fixed;">
    <thead>
      <tr>
        <th style="width: 60px;">ID</th>
        <th style="width: 20%;">Device</th>
        <th style="width: 20%;">Assigned To</th>
        <th style="width: 15%;">Status</th>
        <th style="width: 25%;">Last Activity</th>
        <th style="width: 20%;">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<footer style="display: flex; justify-content: center; align-items: center; gap: 10px; padding: 1rem; background: linear-gradient(to right, #2c3e50, #4a6580); color: white;">
  <img src="https://cdn.octathorpeweb.com/v1/testwicket/hitwicket-logo-2.png" alt="HitWicket Logo" style="height: 30px;">
  <span>© 2025 Kunal Jade - QA (Hitwicket)</span>
</footer>

<!-- Delete Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Confirm Delete</div>
    <p id="deleteDetails"></p>
    <div class="modal-actions">
      <button onclick="closeDeleteModal()">Cancel</button>
      <button class="action-btn delete" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Edit Device</div>
    <label>Device Name</label>
    <input type="text" id="editName" />
    <label>Assigned To</label>
    <input type="text" id="editAssigned" />
    <div class="modal-actions">
      <button onclick="closeEditModal()">Cancel</button>
      <button class="action-btn" onclick="confirmEdit()">Save</button>
    </div>
  </div>
</div>

<!-- History Modal -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Device History</div>
    <div id="historyDeviceName" style="font-weight: 600; margin-bottom: 1rem;"></div>
    <div class="history-list" id="historyList"></div>
    <div class="modal-actions">
      <button onclick="closeHistoryModal()">Close</button>
    </div>
  </div>
</div>

<script>
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbxQ-RFjhnfNICSrY26zEXXRsRILmCt4GetCo5EELCfTWhvhLlgtObC8NMcdFL6lPHfGXQ/exec"; // replace with your Web App URL

  const deviceForm = document.getElementById('deviceForm');
  const deviceNameInput = document.getElementById('deviceName');
  const deviceUserInput = document.getElementById('deviceUser');
  const deviceTableBody = document.querySelector('#deviceTable tbody');

  let devices = [];
  let deleteIndex = null;
  let editIndex = null;

  // Theme functionality
  function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    updateThemeIcon(newTheme);
    
    // Store theme preference in memory
    window.currentTheme = newTheme;
  }

  // Update theme icon based on current theme
  function updateThemeIcon(theme) {
    const themeIcon = document.getElementById('themeIcon');
    if (theme === 'dark') {
      // Moon icon for dark mode with white dots/stars
      themeIcon.innerHTML = `
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="#2D3748"/>
        <circle cx="16" cy="8" r="0.5" fill="white"/>
        <circle cx="18" cy="10" r="0.3" fill="white"/>
        <circle cx="19" cy="7" r="0.4" fill="white"/>
        <circle cx="15" cy="6" r="0.3" fill="white"/>
        <circle cx="17" cy="12" r="0.4" fill="white"/>
      `;
    } else {
      // Sun icon for light mode in yellow
      themeIcon.innerHTML = `
        <circle cx="12" cy="12" r="5" fill="#FFD700"/>
        <line x1="12" y1="1" x2="12" y2="3" stroke="#FFD700" stroke-width="2"/>
        <line x1="12" y1="21" x2="12" y2="23" stroke="#FFD700" stroke-width="2"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="#FFD700" stroke-width="2"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="#FFD700" stroke-width="2"/>
        <line x1="1" y1="12" x2="3" y2="12" stroke="#FFD700" stroke-width="2"/>
        <line x1="21" y1="12" x2="23" y2="12" stroke="#FFD700" stroke-width="2"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="#FFD700" stroke-width="2"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="#FFD700" stroke-width="2"/>
      `;
    }
  }

  // Initialize theme
  function initTheme() {
    const savedTheme = window.currentTheme || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
  }

  // Format date for display
  function formatDate(dateString) {
    if (!dateString || dateString === 'Never') return 'Never';
    
    try {
      // Try parsing as a Date object first
      let date = new Date(dateString);
      
      // If invalid date, try to parse from Google Sheets format
      if (isNaN(date.getTime())) {
        // Handle Google Sheets date format (like "Sat Dec 30 2023 14:30:00 GMT-0500 (EST)")
        const parts = dateString.split(' ');
        if (parts.length >= 5) {
          // Reconstruct a parseable date string
          const timePart = parts[4];
          const timezonePart = parts[5] || '';
          const reconstructed = `${parts.slice(1, 4).join(' ')} ${timePart} ${timezonePart}`;
          date = new Date(reconstructed);
        }
        
        // If still invalid, return the original string
        if (isNaN(date.getTime())) {
          return dateString;
        }
      }
      
      return date.toLocaleString();
    } catch (e) {
      console.error("Error formatting date:", e, dateString);
      return dateString;
    }
  }

  async function loadDevicesFromSheet() {
    try {
      const res = await fetch(SHEET_URL);
      devices = await res.json();
      renderDevices();
    } catch (error) {
      console.error("Error loading devices:", error);
      deviceTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:1.5rem;">Error loading devices. Please try again later.</td></tr>`;
    }
  }

  function renderDevices() {
    deviceTableBody.innerHTML = '';
    if (devices.length === 0) {
      deviceTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:1.5rem;">No devices found. Please add some.</td></tr>`;
      return;
    }
    devices.forEach((d, idx) => {
      const statusText = d.status === 'in' ? 'Checked In' : 'Checked Out';
      const statusClass = d.status === 'in' ? 'status-in' : 'status-out';
      const buttonText = d.status === 'in' ? 'Check Out' : 'Check In';
      
      // Format timestamps for display using our new function
      const lastCheckedIn = d.lastcheckedin ? formatDate(d.lastcheckedin) : 'Never';
      const lastCheckedOut = d.lastcheckedout ? formatDate(d.lastcheckedout) : 'Never';
      const lastActivity = d.status === 'in' ? 
        `Last checked in: ${lastCheckedIn}` : 
        `Last checked out: ${lastCheckedOut}`;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.id}</td>
        <td>${d.name}</td>
        <td>${d.assigned}</td>
        <td class="${statusClass}">${statusText}</td>
        <td>
          <div class="timestamp">${lastActivity}</div>
        </td>
        <td>
          <div class="action-buttons">
            <button class="action-btn check" onclick="toggleCheck(${idx})">${buttonText}</button>
            <button class="action-btn" onclick="openEditModal(${idx})">Edit</button>
            <button class="action-btn history" onclick="openHistoryModal(${idx})">History</button>
            <button class="action-btn delete" onclick="openDeleteModal(${idx})">Delete</button>
          </div>
        </td>`;
      deviceTableBody.appendChild(tr);
    });
  }

  // Add Device
  deviceForm.onsubmit = async function(e) {
    e.preventDefault();
    const name = deviceNameInput.value.trim();
    const assigned = deviceUserInput.value.trim();
    if (!name || !assigned) return alert("Both fields are required!");
    
    try {
      const res = await fetch(SHEET_URL, {
        method: "POST",
        body: JSON.stringify({ action:"add", name, assigned, status:"in", image:"" })
      });
      const result = await res.json();
      if (result.success) {
        await loadDevicesFromSheet();
        deviceForm.reset();
      } else {
        alert("Error adding device: " + (result.error || ""));
      }
    } catch (error) {
      alert("Error adding device. Please try again.");
      console.error("Error adding device:", error);
    }
  };

  // Toggle Check In / Out
  async function toggleCheck(index) {
    const d = devices[index];
    const newStatus = d.status === "in" ? "out" : "in";
    
    try {
      const res = await fetch(SHEET_URL, {
        method: "POST",
        body: JSON.stringify({ action:"update", id:d.id, name:d.name, assigned:d.assigned, status:newStatus, image:d.image })
      });
      const result = await res.json();
      if (result.success) await loadDevicesFromSheet();
      else alert("Error updating status: " + (result.error || ""));
    } catch (error) {
      alert("Error updating status. Please try again.");
      console.error("Error updating status:", error);
    }
  }

  // Delete
  function openDeleteModal(index) {
    deleteIndex = index;
    const d = devices[index];
    document.getElementById('deleteDetails').innerText = `Delete Device:\nID: ${d.id}\n${d.name}\nAssigned To: ${d.assigned}`;
    document.getElementById('deleteModal').style.display = 'flex';
  }
  function closeDeleteModal() { document.getElementById('deleteModal').style.display = 'none'; }
  async function confirmDelete() {
    const d = devices[deleteIndex];
    
    try {
      const res = await fetch(SHEET_URL, {
        method: "POST",
        body: JSON.stringify({ action:"delete", id:d.id })
      });
      const result = await res.json();
      if (result.success) {
        closeDeleteModal();
        await loadDevicesFromSheet();
      } else alert("Error deleting device: " + (result.error || ""));
    } catch (error) {
      alert("Error deleting device. Please try again.");
      console.error("Error deleting device:", error);
    }
  }

  // Edit
  function openEditModal(index) {
    editIndex = index;
    const d = devices[index];
    document.getElementById('editName').value = d.name;
    document.getElementById('editAssigned').value = d.assigned;
    document.getElementById('editModal').style.display = 'flex';
  }
  function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }
  async function confirmEdit() {
    const d = devices[editIndex];
    const newName = document.getElementById('editName').value.trim();
    const newAssigned = document.getElementById('editAssigned').value.trim();
    if (!newName || !newAssigned) return alert("Both fields are required!");
    
    try {
      const res = await fetch(SHEET_URL, {
        method: "POST",
        body: JSON.stringify({ action:"update", id:d.id, name:newName, assigned:newAssigned, status:d.status, image:d.image })
      });
      const result = await res.json();
      if (result.success) {
        closeEditModal();
        await loadDevicesFromSheet();
      } else alert("Error updating device: " + (result.error || ""));
    } catch (error) {
      alert("Error updating device. Please try again.");
      console.error("Error updating device:", error);
    }
  }

  // History
  function openHistoryModal(index) {
    const d = devices[index];
    document.getElementById('historyDeviceName').innerText = `${d.name} (Assigned to: ${d.assigned})`;
    
    // Create history list
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    // Add check-in/out history
    if (d.lastcheckedin && d.lastcheckedin !== 'Never') {
      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `<strong>Checked In:</strong> ${formatDate(d.lastcheckedin)}`;
      historyList.appendChild(item);
    }
    
    if (d.lastcheckedout && d.lastcheckedout !== 'Never') {
      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `<strong>Checked Out:</strong> ${formatDate(d.lastcheckedout)}`;
      historyList.appendChild(item);
    }
    
    // Add creation date if available
    if (d.created && d.created !== 'Never') {
      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `<strong>Added to Inventory:</strong> ${formatDate(d.created)}`;
      historyList.appendChild(item);
    }
    
    // If no history available
    if (historyList.children.length === 0) {
      historyList.innerHTML = '<div class="history-item">No history available for this device.</div>';
    }
    
    document.getElementById('historyModal').style.display = 'flex';
  }
  function closeHistoryModal() { document.getElementById('historyModal').style.display = 'none'; }

  // Backup and Restore
  function backupSheet() {
    const dataStr = JSON.stringify(devices, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `qa-device-inventory-backup-${new Date().toISOString().slice(0,10)}.json`;
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
  }

  function restoreSheet(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const restoredDevices = JSON.parse(e.target.result);
        if (Array.isArray(restoredDevices)) {
          if (confirm(`Restore ${restoredDevices.length} devices? This will replace your current inventory.`)) {
            // Send restore request
            fetch(SHEET_URL, {
              method: "POST",
              body: JSON.stringify({ action:"restore", data:restoredDevices })
            })
            .then(res => res.json())
            .then(result => {
              if (result.success) {
                alert("Restore completed successfully!");
                loadDevicesFromSheet();
              } else {
                alert("Error during restore: " + (result.error || ""));
              }
            })
            .catch(error => {
              alert("Error restoring backup. Please try again.");
              console.error("Restore error:", error);
            });
          }
        } else {
          alert("Invalid backup file format.");
        }
      } catch (error) {
        alert("Error parsing backup file.");
        console.error("Parse error:", error);
      }
    };
    reader.readAsText(file);
    event.target.value = ''; // Reset file input
  }

  // Initialize
  initTheme();
  loadDevicesFromSheet();
</script>
</body>
</html>
